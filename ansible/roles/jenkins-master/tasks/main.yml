---
# cf https://github.com/geerlingguy/ansible-role-jenkins
# or https://github.com/ICTO/ansible-jenkins (for Ubuntu)

- name: create slave directory
  file: path=/data/slaves
        state=directory
        owner=root
        group=root
        mode=0755

- name: add nginx yum repo
  yum:
    name: "{{ nginx_repo_url }}"

- name: add jenkins yum repo
  get_url: url="{{ jenkins_repo_url }}"
           dest=/etc/yum.repos.d/jenkins.repo

- name: add jenkins key
  rpm_key: key="{{ jenkins_repo_key_url }}" state=present

- name: install packages
  yum: pkg={{ item }} state=present
  with_items:
    - nginx
    - jenkins
    - java-1.8.0-openjdk

- name: install nginx.conf file
  template: src=nginx.conf.j2
            dest=/etc/nginx/nginx.conf
  notify: restart nginx

- name: remove nginx default.conf
  file:
    path=/etc/nginx/conf.d/default.conf
    state=absent
  notify: restart nginx

- name: install vhost config
  template: src=nginx-vhost.conf.j2
            dest="/etc/nginx/conf.d/{{ domain }}.conf"
  notify: restart nginx

- name: install contribute.json
  template: src=contribute.json.j2
            dest=/usr/share/nginx/html/contribute.json

- name: add logrotate config
  copy: src=logrotate.conf dest=/etc/logrotate.d/nginx

- name: make nginx vhost logdir
  file: path="/var/log/nginx/{{ domain }}"
        state=directory
        owner=nginx
        group=wheel
        mode=0750

- name: manage nginx service
  service: name=nginx
           enabled=yes
           state=started

- name: make jenkins logdir
  file: path=/var/log/jenkins
        state=directory
        owner=jenkins
        group=jenkins
        mode=0755

- name: change jenkins config
  lineinfile: dest=/etc/sysconfig/jenkins
              regexp="{{ item.regexp }}"
              line="{{ item.line }}"
  with_items:
    - { regexp: '^JENKINS_ARGS=', line: 'JENKINS_ARGS=--prefix=/{{ jenkins_prefix }}' }
  notify: restart jenkins

- name: enable jenkins service
  service: name=jenkins state=started enabled=yes

- name: wait for jenkins to start
  shell: curl --head --silent http://localhost:8080/{{ jenkins_prefix }}/whoAmI/
  register: result
  until: result.stdout.find("200 OK") != -1
  retries: "{{ jenkins_connection_retries }}"
  delay: "{{ jenkins_connection_delay }}"
  changed_when: false

- name: Get the jenkins-cli jarfile from the Jenkins server.
  get_url:
    url: "http://localhost:8080/{{ jenkins_prefix }}/jnlpJars/jenkins-cli.jar"
    dest: "{{ jenkins_jar_location }}"
    force: yes
  register: jarfile_get
  until: "'OK' in jarfile_get.msg or 'file already exists' in jarfile_get.msg"
  retries: 5
  delay: 15

# Credentials used by plugin install need to be managed some how, but
# secrets in credentials.xml are encrypted with a master secret

# Update Jenkins and install configured plugins.
- include: plugins.yml
